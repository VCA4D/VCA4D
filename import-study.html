<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Import a study</title>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.15.3/xlsx.full.min.js"
    ></script>
  </head>

  <body>
    <h1>Import a Study</h1>

    <h2>Step 1: Import study's XLS file and convert it to JSON</h1>
      <input type="file" id="fileUpload" accept=".xls,.xlsx" /><br />
    <button type="button" id="uploadExcel">Convert</button>
    <br/>
    <br/>
    Output:
    <br/>
    <textarea id="jsonData" style="width: 100%; height: 150px;"></textarea>
    
    
    <h2>Step 2: Generate the study JSON file (with data populated from the Excel file)</h2>
    <button type="button" id="convertToStudyFile">Generate</button>
    <br/>
    <br/>
    Output:
    <br/>
    <textarea id="studyAsJson" style="width: 100%; height: 150px;"></textarea>
    
    <div id="errors" style="display: none;">
      <div>Errors:</div>
      <p id="error-details"></p>
    </div>
    
    <h2>Step 3: Download the generated study JSON file or save it to browser's localStorage</h2>
    <button type="button" id="downloadStudyFile">Download</button>
    <button type="button" id="saveStudyToBrowser">Save to localStorage</button>
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    
  </body>
  <script>
    var selectedFile;
    document
      .getElementById("fileUpload")
      .addEventListener("change", function (event) {
        selectedFile = event.target.files[0];
      });
    document
      .getElementById("uploadExcel")
      .addEventListener("click", function () {
        if (selectedFile) {
          var fileReader = new FileReader();
          fileReader.onload = function (event) {
            var data = event.target.result;

            var workbook = XLSX.read(data, {
              type: "binary"
            });
            var output = {};
            workbook.SheetNames.forEach((sheet) => {
              let rowObject = XLSX.utils.sheet_to_row_object_array(
                workbook.Sheets[sheet]
              );
              output[sheet] = rowObject;
            });
            var outputAsJson = JSON.stringify(output);
            window.json_from_xls = output;
            document.getElementById("jsonData").innerHTML = outputAsJson;
          };
          fileReader.readAsBinaryString(selectedFile);
        }
      });

      const getErrors = (study) => {
        let errors = []

        if (!['BIF', 'CFA'].includes(study.localCurrency)) {
          errors.push(`<span style="color: red;">Unknown currency ${study.localCurrency}</span>`)
        }
        for (const property of [
          'product',
          'country',
          'year',
        ]) {
          if (!study[property]) {
            errors.push(`<span style="color: red;">Missing property ${property}</span>`)
          }
        }
        for (const property of [
          'valueAddedShareOfGDP',
          'valueAddedShareOfAgriculturalGDP',
          'rateOfIntegrationIntoDomesticEconomy',
          'publicFundsBalancePublicBudgetRatio',
          'balanceOfTradeOfValueChain',
          'domesticResourceCostRatio',
          'giniIndex',
          'totalValueAdded',
          'publicFundBalance',
          'nominalProtectionCoefficient',
        ]) {
          if (!study[property]) {
            errors.push(`Missing property ${property}`)
          }
        }
        study.data.stages.filter(stage => !stage.description).map(stage => {
          errors.push(`Stage ${stage.name} has no description`)
        })
        const stageNames = study.data.stages.map(stage => stage.name)
        study.data.actors.filter(actor => !stageNames.includes(actor.stage)).map(actor => {
          errors.push(`<span style="color: red;">Actor ${actor.name} has a stage ${actor.stage} not defined in Stages</span>`)
        })
        const actorNames = study.data.actors.map(actor => actor.name)
        study.data.flows.filter(flow => !actorNames.includes(flow.buyerActorName) || !actorNames.includes(flow.sellerActorName)).map(flow => {
          errors.push(`<span style="color: red;">Unknown actor name in flow ${flow}</span>`)
        })

        const totalCreatedAddedValue = study.data.actors.map(actor => actor.directAddedValue || 0).reduce((res, curr) => res + curr, 0)
        let totalReceivedAddedValue = study.data.actors.map(actor => actor.receivedAddedValue).reduce((res, curr) => res + curr, 0)
        for (const key in study.data.addedValue) {
          totalReceivedAddedValue += study.data.addedValue[key]
        }
        const diff = Math.round(Math.abs(totalCreatedAddedValue - totalReceivedAddedValue))
        if (diff > 0) {
          errors.push(`<span style="color: red;">Total added value created and received should match, diff = ${diff}</span>`)
        }
        return errors
      }

      const getStudyProperty = (json_from_xls, property_name) => {
        return json_from_xls["Value Chain"].find((el => {return el["Property"] == property_name;}))["Value"];
      };

      const slugify = str =>
        str
          .toLowerCase()
          .trim()
          .replace(/[^\w\s-]/g, '')
          .replace(/[\s_-]+/g, '-')
          .replace(/^-+|-+$/g, '');
      
      function download(content, mimeType, filename){
        const a = document.createElement('a'); // Create "a" element
        const blob = new Blob([content], {type: mimeType}); // Create a blob (file-like object)
        const url = URL.createObjectURL(blob); // Create an object URL from blob
        a.setAttribute('href', url); // Set "a" element link
        a.setAttribute('download', filename); // Set download filename
        a.click(); // Start downloading
      }

      const createStudyDataFromJson = (json) => {
        const stages = json["Stages description"].map((stage, index) => ({
            name: stage['Stages'],
            description: stage['Description'] || '',
            index
          })
        )

        let actors = json["Actor types"].map(actor => ({
            name: actor['Actor type name'],
            stage: actor['Stage'] || '',
            id: actor['Actor type code']
          })
        )
        const flows = json["Flow by actor type"].map(flow => ({
          sellerActorName: flow['Seller Name'],
          buyerActorName: flow['Buyer Name'],
          volumeExchanged: flow['Volume exchanged (kg Of product)'],
          monetaryValue: flow['Monetary value'],
          unitPrice: flow['Unitary price (local curency)'],
          volumeUnit: flow['Volume Unit'],
          product: flow['Products']
        }))
        const indicators = json["Indicator by actor type"].map(indicator => ({
          actorName: indicator['Actor type Name'],
          data: {
            numberOfActors: indicator['Number Of actors In the value chain'] || 0,
            directAddedValue: indicator['Direct added value (local currency)'] || 0,
            publicFundsBalance: indicator['Public funds balance (local currency)'] || 0,
            netOperatingProfit: indicator['Net operating profit (local currency)'] || 0,
            totalCosts: indicator['Total costs (local currency)'] || 0
          }
        }))
        actors = actors.map(actor => {
          let indicator = indicators.filter(indicator => indicator.actorName === actor.name)
          if (indicator && indicator.length === 1) {
            indicator = indicator[0]
            return {
              ...actor,
              ...indicator.data
            }
          }
          return actor
        })
        const addedValueItems = json["Direct value added receivers"].map(addedValue => ({
            receiverName: addedValue['Receiver Name'],
            value: addedValue['value (local currency)'] || 0
          })
        )
        actors = actors.map(actor => {
          const addedValue = addedValueItems.filter(addedValue => addedValue.receiverName === actor.name)[0]
          return {
            ...actor,
            receivedAddedValue: addedValue?.value || 0
          }
        })

        const addedValue = {
          landOwnersFees: addedValueItems.filter(element => element.receiverName === 'Land owners (land fees)')[0].value,
          depreciation: addedValueItems.filter(element => element.receiverName === 'Depreciation')[0].value,
          employeeWages: addedValueItems.filter(element => element.receiverName === 'Employees (wages)')[0].value,
          financialInstitutionsInterests: addedValueItems.filter(element => element.receiverName === 'Financial institutions (interests On loans)')[0].value,
          government: addedValueItems.filter(element => element.receiverName === 'Government (taxes - subsidies)')[0].value,
        }

        const employments = json["Employment"].map(employment => {
          const tempMale = employment['Temporary Male']
          const tempFemale = employment['Temporary Female']
          const unskilledMale = employment['Permanent Unskilled Male']
          const unskilledFemale = employment['Permanent Unskilled Female']
          const skilledMale = employment['Permanent Skilled Male']
          const skilledFemale = employment['Permanent Skilled Female']
          return {
            actorName: employment['Actor type Name'],
            data: {
              tempMale,
              tempFemale,
              unskilledMale,
              unskilledFemale,
              skilledMale,
              skilledFemale,
              totalMale: tempMale + unskilledMale + skilledMale,
              totalFemale: tempFemale + unskilledFemale + skilledFemale,
              totalTemp: tempMale + tempFemale,
              totalSkilled: skilledFemale + skilledMale,
              totalUnskilled: unskilledFemale + unskilledMale,
              total: tempMale + tempFemale + skilledFemale + skilledMale + unskilledFemale + unskilledMale
            }
          }
        })
        actors = actors.map(actor => {
          let employment = employments.filter(employment => employment.actorName === actor.name)
          if (employment && employment.length === 1) {
            employment = employment[0]
            return {
              ...actor,
              employment: {
                ...employment.data
              }
            }
          }
          return actor
        })

        const accountItems = json["Account by actor type"].map(accountItem => ({
            actorName: accountItem['Actor type name'],
            data: {
              costOrRevenue: accountItem['Cost Or revenue'],
              item: accountItem['Item'],
              value: accountItem['Value']
            }
          })
        )
        actors = actors.map(actor => {
          let accountItem = accountItems.filter(element => element.actorName === actor.name)
          if (accountItem && accountItem.length === 1) {
            accountItem = accountItem[0]
            return {
              ...actor,
              accountItems: {
                ...accountItem.data
              }
            }
          }
          return actor
        })
        actors.sort((actor1, actor2) => {
          const stage1 = stages.find(stage => stage.name === actor1.stage)
          const stage2 = stages.find(stage => stage.name === actor2.stage)
          return (stage1?.index || 0) - (stage2?.index || 0) 
        })

        return {
          stages,
          actors,
          flows,
          addedValue
        }
      }

      const studyDefaultEnvironment = {
        "brief": [
            "Sustainability of walnut and almond production and export sub-sectors.",
            "Optimization of energy consumption to be sought for the embryonic juice sub-sector from cashew apples."
        ],
        "impacts" : {
            "mid-points": {
                "Global-warming": {
                    "Agricultural-production": -154565235.678,
                    "Collection": 102549.907115,
                    "Processing": 198568.619229,
                    "Retail": 1924.33492,
                    "Export": 0,
                    "Transport": 3763849.3292988
                },
                "Stratospheric-ozone-depletion": {
                    "Agricultural-production": 28.90294639575,
                    "Collection": 0.056650125186,
                    "Processing": 1.63613197687,
                    "Retail": 0.001105149,
                    "Export": 0,
                    "Transport": 2.1820214281845
                },
                "Ionizing-radiation": {
                    "Agricultural-production": 32691.12756042,
                    "Collection": 17619.4683194,
                    "Processing": 4702.8165507,
                    "Retail": 297.30166,
                    "Export": 0,
                    "Transport": 565328.92152534
                },
                "Ozone-formation-human-health": {
                    "Agricultural-production": 4171.156200435,
                    "Collection": 470.61287818,
                    "Processing": 1503.91500265,
                    "Retail": 9.8170512,
                    "Export": 0,
                    "Transport": 19679.843720523
                },
                "x": {
                    "Agricultural-production": -1,
                    "Collection": -1,
                    "Processing": -1,
                    "Retail": -1,
                    "Export": 0,
                    "Transport": -1
                }
            },
            "human-health" : {
                "Global-warming-human-health": {
                    "Agricultural-production": -143.4336813315,
                    "Collection": 0.095167188356,
                    "Processing": 0.184375752037,
                    "Retail": 0.00178580208,
                    "Export": 0,
                    "Transport": 3.4928912650716
                },
                "Stratospheric-ozone-depletion": {
                    "Agricultural-production": 0.01534480418499,
                    "Collection": 0.0000300577262171,
                    "Processing": 0.00086916969847,
                    "Retail": 0.00000058638192,
                    "Export": 0,
                    "Transport": 0.00115776329416797
                },
                "Ionizing-radiation": {
                    "Agricultural-production": 0.0002773563184077,
                    "Collection": 0.000149479705486,
                    "Processing": 0.000039901212634,
                    "Retail": 0.00000252224244,
                    "Export": 0,
                    "Transport": 0.0047961276047286
                },
                "Ozone-formation-human-health": {
                    "Agricultural-production": 0.003793773513285,
                    "Collection": 0.00042826083775,
                    "Processing": 0.00136768300978,
                    "Retail": 0.000008933564,
                    "Export": 0,
                    "Transport": 0.017908744728378
                },
                "Fine-particulate-matter-formation": { 
                    "Agricultural-production": 1.944441248358,
                    "Collection": 0.082726442617,
                    "Processing": 1.42965930651,
                    "Retail": 0.00155118196,
                    "Export": 0,
                    "Transport": 3.0334241805966
                },
                "Human-carcinogenic-toxicity": {
                    "Agricultural-production": 0.08672719829046,
                    "Collection": 0.0149955266767,
                    "Processing": 0.0148546092952,
                    "Retail": 0.000265783408,
                    "Export": 0,
                    "Transport": 0.51227955904419
                },
                "Human-non-carcinogenic-toxicity": {
                    "Agricultural-production": 0.09191459917395,
                    "Collection": 0.032245608235,
                    "Processing": 0.0261660881502,
                    "Retail": 0.0005226232,
                    "Export": 0,
                    "Transport": 0.98219875003257
                },
                "Water-consumption-human-health": {
                    "Agricultural-production": 0.05779269102957,
                    "Collection": 0.5582300364,
                    "Processing": 0.054504001302,
                    "Retail": 0.009398398,
                    "Export": 0,
                    "Transport": 17.8600960388172
                },
                "x": {
                    "Agricultural-production": false,
                    "Collection": false,
                    "Processing": false,
                    "Retail": false,
                    "Export": 0,
                    "Transport": false
                }
            }
        }
      };

      document
      .getElementById("convertToStudyFile")
      .addEventListener("click", function () {
        let json_from_xls = window.json_from_xls;
        const country = getStudyProperty(json_from_xls, "Country");
        const commodity = getStudyProperty(json_from_xls, "Commodity");
        const year = getStudyProperty(json_from_xls, "Reference Year");
        const localCurrency = getStudyProperty(json_from_xls, "Currency");
        const valueAddedShareOfGDP = getStudyProperty(json_from_xls, "Value added share Of national GDP");
        const valueAddedShareOfAgriculturalGDP = getStudyProperty(json_from_xls, "Value added share Of the agricultural sector GDP");
        const rateOfIntegrationIntoDomesticEconomy = getStudyProperty(json_from_xls, "Rate Of integration into domestic economy");
        const publicFundsBalancePublicBudgetRatio = getStudyProperty(json_from_xls, "Public funds balance / Public budget");
        const balanceOfTradeOfValueChain = getStudyProperty(json_from_xls, "Balance Of trade Of the value chain");
        const domesticResourceCostRatio = getStudyProperty(json_from_xls, "Domestic resource cost ratio");
        const giniIndex = getStudyProperty(json_from_xls, "Gini index");
        const totalValueAdded = getStudyProperty(json_from_xls, "Total value added");
        const publicFundBalance = getStudyProperty(json_from_xls, "Public fund balance");
        const nominalProtectionCoefficient = getStudyProperty(json_from_xls, "Nominal protection coefficient");
        
        const id = slugify(commodity + "-" + country + "-" + year);

        const studyData = createStudyDataFromJson(json_from_xls)
        const study = {
          id,
          product: commodity,
          country,
          year,
          localCurrency,
          valueAddedShareOfGDP,
          valueAddedShareOfAgriculturalGDP,
          rateOfIntegrationIntoDomesticEconomy,
          publicFundsBalancePublicBudgetRatio,
          balanceOfTradeOfValueChain,
          domesticResourceCostRatio,
          giniIndex,
          totalValueAdded,
          publicFundBalance,
          nominalProtectionCoefficient,
          environment : studyDefaultEnvironment, // TODO: fill. But it looks that data contained in this key comes from another xls file.
          data: studyData
        };
        const errors = getErrors(study)
        if (errors.length > 0) {
          document.getElementById('errors').style.display = 'inline-block'
          document.getElementById('error-details').innerHTML = errors.join('<br>')
        } 
        window.study = study;
        const study_as_str = JSON.stringify(study);
        document.getElementById("studyAsJson").innerHTML = study_as_str;
      });

      document
      .getElementById("downloadStudyFile")
      .addEventListener("click", function () {
        const study_as_str = JSON.stringify(window.study);
        download(study_as_str, "application/json", window.study.id+".json");
      });

      document
      .getElementById("saveStudyToBrowser")
      .addEventListener("click", function () {
        const study_as_str = JSON.stringify(window.study);
        localStorage.setItem('study', study_as_str);
      });
  </script>
</html>
